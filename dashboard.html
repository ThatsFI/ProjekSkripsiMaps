<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cluster Map per Jam</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 56px;
        background-color: #ffffff;
        color: rgb(0, 0, 0);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        z-index: 2000;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        box-sizing: border-box;
      }

      .navbar-title {
        font-size: 18px;
        font-weight: 600;
        white-space: nowrap;
      }

      .navbar-menu {
        display: flex;
        gap: 10px;
      }

      .navbar-button {
        color: white;
        text-decoration: none;
        font-weight: 500;
        background-color: #2583ff;
        padding: 6px 14px;
        border-radius: 6px;
        transition: background-color 0.2s;
        white-space: nowrap;
      }

      .navbar-menu a:hover {
        background-color: #1900a8;
      }

      .navbar-logout {
        color: white;
        text-decoration: none;
        font-weight: 500;
        background-color: #ff0000;
        padding: 6px 14px;
        border-radius: 6px;
        transition: background-color 0.2s;
        white-space: nowrap;
      }

      .navbar-logout a:hover {
        background-color: #d30000;
      }

      /* style body */
      body {
        margin: 0;
        padding-top: 56px;
        font-family: "Segoe UI", Roboto, sans-serif;
      }

      /* map */
      #map {
        position: absolute;
        top: 56px;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1;
      }

      /* pemilihan jam bagian bawah */
      #controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1500;
        background-color: rgba(255, 255, 255, 0.95);
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      /* label dan dropdown */
      #controls label {
        font-weight: 600;
        font-size: 14px;
        color: #333;
      }

      #controls select {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 14px;
        background-color: #fff;
        color: #333;
        transition: border-color 0.2s;
      }

      #controls select:focus {
        border-color: #007bff;
        outline: none;
      }

      .leaflet-legend {
        line-height: 18px;
        color: #333;
        background: white;
        padding: 10px 14px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        font-size: 13px;
        margin-top: 10px;
      }

      .leaflet-legend i {
        width: 12px;
        height: 12px;
        float: left;
        margin-right: 8px;
        margin-top: 3px;
        opacity: 0.8;
        border-radius: 2px;
      }

      /* tampilan responsif layar hp */
      @media (max-width: 768px) {
        .navbar {
          flex-direction: row;
          align-items: center;
          height: auto;
          padding: 18px 16px;
        }

        .navbar-title {
          font-size: 16px;
        }

        #controls {
          flex-direction: column;
          align-items: stretch;
          padding: 10px;
        }

        #controls label,
        #controls select {
          font-size: 16px;
        }

        .leaflet-legend {
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <!-- navbar -->
    <div class="navbar">
      <div class="navbar-title">
        Penentuan Area Strategis Berbasis Titik Ramai
      </div>
      <div class="navbar-menu">
        <a href="/dashboard2" class="navbar-button">Heatmap</a>
        <a href="/logout" class="navbar-logout">Logout</a>
      </div>
    </div>

    <div>
      <div id="controls">
        <label for="hourSelect">Pilih Jam:</label>
        <select id="hourSelect"></select>
      </div>

      <!-- elemen peta -->
      <div id="map"></div>
    </div>

    <!-- load library leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
      // Inisialisasi peta dengan koordinat tengah Makassar
      const map = L.map("map").setView([-5.120475, 119.415943], 12);
      // Tambahkan tile layer dari OpenStreetMap
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      // Variabel untuk menyimpan data dan layer marker
      let allData = null;
      let markerLayer = null;

      // Fungsi untuk menentukan warna berdasarkan ID cluster
      function getColor(clusterId) {
        const colors = ["blue", "green", "red"];
        return colors[clusterId % colors.length];
      }

      // Fungsi untuk menyesuaikan ukuran marker berdasarkan ukuran layar
      function getMarkerRadius() {
        return window.innerWidth < 768 ? 10 : 6;
      }

      // Fungsi untuk menampilkan marker pada jam tertentu
      function showMarkersForHour(hour) {
        if (!allData) return;

        // Filter data berdasarkan jam yang dipilih
        const features = allData.features.filter(
          (f) => f.properties.HourOfDay === hour
        );

        // Hapus layer lama jika ada
        if (markerLayer) {
          map.removeLayer(markerLayer);
        }

        // Tambahkan marker baru berdasarkan data filter
        markerLayer = L.geoJSON(features, {
          pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
              radius: getMarkerRadius(),
              fillColor: getColor(feature.properties.cluster),
              color: "#000",
              weight: 1,
              fillOpacity: 0.8,
            });
          },
          onEachFeature: function (feature, layer) {
            // Tambahkan popup dengan info cluster dan link ke Google Maps
            const lat = feature.geometry.coordinates[1];
            const lon = feature.geometry.coordinates[0];
            const cluster = feature.properties.cluster;
            const gmapsURL = `https://www.google.com/maps?q=${lat},${lon}`;

            layer.bindPopup(`
              <b>Cluster:</b> ${cluster}<br><br>
              <a href="${gmapsURL}" target="_blank">Buka di Google Maps</a>
            `);
          },
        }).addTo(map);
      }

      // pengambilan data dari hasil clustering
      fetch("clustering_result.geojson")
        .then((res) => res.json())
        .then((data) => {
          allData = data;

          // Ambil semua jam unik dari data
          const hours = [
            ...new Set(data.features.map((f) => f.properties.HourOfDay)),
          ].sort((a, b) => a - b);

          // Tambahkan opsi jam ke dropdown
          const select = document.getElementById("hourSelect");
          hours.forEach((hour) => {
            const option = document.createElement("option");
            option.value = hour;
            option.textContent = `${hour}:00`;
            select.appendChild(option);
          });

          // Tampilkan marker untuk jam pertama
          showMarkersForHour(hours[0]);

          // Tambahkan event saat jam berubah
          select.addEventListener("change", (e) => {
            const selectedHour = parseInt(e.target.value);
            showMarkersForHour(selectedHour);
          });
        });

      // Tambahkan keterangan warna di peta
      const legend = L.control({ position: "topright" });
      legend.onAdd = function (map) {
        const div = L.DomUtil.create("div", "leaflet-legend");
        div.innerHTML = `
          <strong>Keterangan Warna</strong><br>
          <i style="background:red"></i> Ramai Penjualan<br>
          <i style="background:green"></i> Lumayan Ramai<br>
          <i style="background:blue"></i> Kurang Ramai
        `;
        return div;
      };
      legend.addTo(map);

      // Resize ulang marker saat ukuran layar berubah
      window.addEventListener("resize", () => {
        const selectedHour = parseInt(
          document.getElementById("hourSelect").value
        );
        showMarkersForHour(selectedHour);
      });
    </script>
  </body>
</html>
